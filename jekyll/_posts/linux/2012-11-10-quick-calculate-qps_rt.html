---
layout: tech-post
title: 快速取得apache/nginx的qps和rt
category: linux
change_frequency: monthly
---

<p>
在计算QPS和RT的时候，我们一般使用grep 。但是当日志文件很大的时候，grep会很耗时。
</p>
<p>
监控系统中计算的方法是记录上次采样的行，下次读取的时候从记录的位置开始。所以不存在这个问题。
</p>
<p>
但是如果我们仅仅希望链接到服务器，执行一条命令就快速的计算出qps和rt。则需要考虑如何快速读取需要的行的问题：
</p>
<p>
经过我这几天的考虑，总结出了下面一条命令。计算qps和rt算是很快了。如果谁有比这个更秒的方法，不吝赐教：
</p>

<div id="outline-container-1" class="outline-3">
<h3 id="sec-1">脚本</h3>
<div class="outline-text-3" id="text-1">




<pre class="src src-sh"><span style="color: #ffd700; font-style: italic;">srm</span>=<span style="color: #f0e68c;">" \[`date -d ' -1 second '  +%d\\\/%h\\\/%Y:%H:%M:%S` +0800\] "</span>
<span style="color: #ffd700; font-style: italic;">QPS_RT</span>=$(<span style="color: #fa8072;">tac</span> $<span style="color: #ffd700; font-style: italic;">acc_logs</span>|sed -n -e  <span style="color: #f0e68c;">'/'"$srm"'/,${</span>
<span style="color: #f0e68c;">/'"$srm"'/p</span>
<span style="color: #f0e68c;">/'"$srm"'/!q}'</span> | awk <span style="color: #f0e68c;">'{sum+=$2;count++}END{printf "%d,%.2f",count,sum/count/1000}'</span>
)
</pre>


</div>

</div>

<div id="outline-container-2" class="outline-3">
<h3 id="sec-2">说明</h3>
<div class="outline-text-3" id="text-2">


<p>
   第一行取得日志中的时间字符串，这里取的前一秒的。  
</p>
<p>
   第二行使用linux下到命令得到qps和rt的平均值。
</p></div>
</div>
