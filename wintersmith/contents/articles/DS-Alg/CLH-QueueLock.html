---
date: 2014-10-14 22:25:11
template: tech.jade
title: CLH 队列锁
category: DS-Al
chage_frequency: monthly
tag: 
---
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">优势/特点</a></li>
<li><a href="#sec-2">实现原理</a></li>
</ul>
</div>
</div>
<p>
CLH队列锁有很多优势，Java的ASQ同步器就基于CLH锁。
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">优势/特点</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>实现公平调度 - FIFO, fair
</li>
<li>无饥饿 - starvation-free
</li>
<li>无竞争情况下，内存占用少
</li>
<li>spin在单一内存地址上，cache miss hit少
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">实现原理</h2>
<div class="outline-text-2" id="text-2">
<pre class="example">
+----------------------+   prev   +----------------------+
|        node1         | &lt;------  | node2                |
| {succ_must_wait = 1} |          | {succ_must_wait = 1} |
+----------------------+          +----------------------+
                                       ^
                                       | 
                                      tail
</pre>
<p>
如上图，每个node代表一个阻塞获取的锁进程。
</p>
<dl class="org-dl">
<dt> lock </dt><dd>将自己插入到 <b>tail</b> 所指的队尾，然后不断的检查previous节点的 <i>succ\<sub>must\</sub><sub>wait</sub></i> 字段，判断锁是否被前面进程释放，如果释放，则将previous节点移除，代表自己获取锁成功
</dd>
<dt> unlock </dt><dd>将自己节点的 <i>succ\<sub>must\</sub><sub>wait</sub></i> 字段设置为0，表示自己释放对锁的占有
</dd>
</dl>
</div>
</div>
