#+BEGIN_HTML
---
date: 2014-10-14 22:25:11
template: tech.jade
title: CLH 队列锁
category: DS-Al
chage_frequency: monthly
tag: 
---
#+END_HTML
#+OPTIONS: toc:nil
#+TOC: headlines 2
CLH队列锁有很多优势，Java的ASQ同步器就基于CLH锁。

** 优势/特点 
+ 实现公平调度 - FIFO, fair
+ 无饥饿 - starvation-free
+ 无竞争情况下，内存占用少
+ spin在单一内存地址上，cache miss hit少

** 实现原理
#+BEGIN_EXAMPLE
+----------------------+   prev   +----------------------+
|        node1         | <------  | node2                |
| {succ_must_wait = 1} |          | {succ_must_wait = 1} |
+----------------------+          +----------------------+
                                       ^
                                       | 
                                      tail
#+END_EXAMPLE
如上图，每个node代表一个阻塞获取的锁进程。
+ lock :: 将自己插入到 *tail* 所指的队尾，然后不断的检查previous节点的 /succ\_must\_wait/ 字段，判断锁是否被前面进程释放，如果释放，则将previous节点移除，代表自己获取锁成功
+ unlock :: 将自己节点的 /succ\_must\_wait/ 字段设置为0，表示自己释放对锁的占有
